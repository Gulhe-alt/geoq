<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="searchsupport.css">

    <title>POGO Search</title>
    <style>
      .fieldLabel {
        /*        font-weight: bold;*/
      }
      .scroller {
        overflow:scroll;
      }
      .sized {
        height:30em;
      }
      .shaded {
        background: antiquewhite;
      }
      .pointer {
        cursor: pointer;
      }


      .dont-break-out {
        /* https://css-tricks.com/snippets/css/prevent-long-urls-from-breaking-out-of-container/ */

        /* These are technically the same, but use both */
        overflow-wrap: break-word;
        word-wrap: break-word;

        -ms-word-break: break-all;
        /* This is the dangerous one in WebKit, as it breaks things wherever */
        word-break: break-all;
        /* Instead use this non-standard one: */
        word-break: break-word;

        /* Adds a hyphen where the word breaks, if supported (No Blink) */
        -ms-hyphens: auto;
        -moz-hyphens: auto;
        -webkit-hyphens: auto;
        hyphens: auto;

      }      
    </style>
  </head>

  <body>
    <div class="container-fluid" id="firstContainer">
      <div class="row">
        <div class="col text-center">POGO Search</div>
      </div>
      <div class="row">
        <div class="col-4">
          <div class="card"  style="height:100%">
            <div class="card-body">
              <h5 class="card-title">Search</h5>
              <div class="row">
                <div class="col-4"><select id="searchType">
                    <option value="byLabel">By Name</option>
                    <option value="byLabelAndAnnos">Full </option>
                  </select></div>
                <div class="col-8">
                  <input type="text" class="form-control form-control-sm typeahead" id="search"/>
                </div>
              </div>
              <div class="row">
              <h5>Results</h5>
              <div class="col-12">
                <div id="resultHolder">
                </div>
              </div>
              </div>
              <div class="row">
                <h5>Details</h5>
                <div class="col-12">
                  <div>
                    <span class="fieldLabel">Label: </span><span id="dLabel"></span>
                  </div>
                Annotations: 
                <div id="dAnnotations">
                </div>
                Children: 
                <div id="dKids">

                </div>
                Parents:
                <div id="dParents"></div>
              </div>
            </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script type="text/javascript" src="typeahead.js/typeahead.bundle.js"></script>
    <!--    <script type="text/javascript" src="searchsupport.js"></script>-->
    <script type="text/javascript" src="vowl/vontology.js"></script>
    <script type="text/javascript" src="vowl/vowlHelper.js"></script>
    <script type="text/javascript">

      let substringMatcher = function (strs) {
        return function findMatches(q, cb) {
          var matches, substringRegex;
          matches = [];
          substrRegex = new RegExp(q, 'i');
          $.each(strs, function (i, str) {
            if (substrRegex.test(str)) {
              matches.push(str);
            }
          });
          cb(matches);
        };
      };

      var terms = vowlHelper.getLabels();

      $('#search').typeahead({
        hint: true,
        highlight: true,
        minLength: 1
      },
              {
                name: 'terms',
                source: substringMatcher(terms)
              }
      );


      $('#search').keyup(function (e) {
        if (e.keyCode == 13 && $("#search").val() != "") {
          console.log("Starting Search")
          results = vowlHelper.byLabel($("#search").val());
          console.log("Results from Search: " + results)
          $('.typeahead').typeahead('close');
          listSearchResults(results);
          showTermDetails(null);
        }
      });


      function listSearchResults(results) {

        let html = "";
        if (results) {
          totalResults = []
          for (let i = 0; i < results.length; i++) {
            let term = results[i];
            html += "<div class='pointer searchResult ";
            if (i % 2 == 0)
              html += " shaded ";
            html = html + "' data-id='" + term.id + "'>";
            if (term.label["undefined"])
              html += term.label["undefined"];
            else if (term.label["IRI-based"])
              html += term.label["IRI-based"];
            html += "</div>";
          }
          $("#resultHolder").html(html);

          

          $('.searchResult').each(function(i, obj) {
            localResults = showTermDetailsById($(obj).attr("data-id"))
            totalResults.push(...localResults)
          });

          $(".searchResult").click(function (e) {
            console.log(e)
            let target = $(e.target);
            showTermDetailsById(target.data("id"))
          });
        }

        console.log("Total Results: ")
        console.log(totalResults)
      }

      function sortByName(a, b) {
        let name1 = "";
        let name2 = "";

        if (a.label["undefined"])
          name1 = a.label["undefined"];
        else if (a.label["IRI-based"])
          name1 = a.label["IRI-based"];

        if (b.label["undefined"])
          name2 = b.label["undefined"];
        else if (b.label["IRI-based"])
          name2 = b.label["IRI-based"];

        let answer = 0;
        if (name1 > name2) {
          answer = 1;
        } else if (name1 < name2) {
          answer = -1;
        }
        return answer;
      }

      function showTermDetails(term) {
        if (term == null) {
          $("#dLabel").text("");
          $("#dAnnotations").html("");
          $("#dKids").html("");
          $("#dParents").html("");
          return;
        }
        if (term.label["undefined"])
          $("#dLabel").text(term.label["undefined"]);
        else if (term.label["IRI-based"])
          $("#dLabel").text(term.label["IRI-based"]);
        let anos = "";
        if (term.annotations)
          for (const [key, value] of Object.entries(term.annotations)) {
            console.debug(key, value);
            anos += "<div><span class='fieldLabel annotations'>" + key + ":</span> <span>" + value[0].value + " </div>";
          }
        $("#dAnnotations").html(anos);

        let subs = "<ul>";
        let children = []
        children.push(term)
        if (term.subClasses) {
          for (let i = 0; i < term.subClasses.length; i++) {
            let extraClass = "";
            if (i % 2 === 0)
              extraClass = "shaded";
            let cid = term.subClasses[i];
            cterm = vowlHelper.getTermById(cid);
            children.push(cterm)
            label = cterm.label["undefined"];
            subs += "<li class='pointer " + extraClass + "' onclick='showTermDetailsById(" + cid + "," + term.id + ")'>"
                    + label + "</li>";
          }
        }
        subs += "</ul>";
        $("#dKids").html(subs);

        let parents = "<ul>";
        if (term.superClasses)
          $("#dParents").html(buildInheritanceNavList(term.superClasses));
        else
          $("#dParents").html("<ul><li>None</li></ul>");
        return children

      }
      function buildInheritanceNavList(items) {
        let count = 0;
        let html = "<ul>";
        var extraclass = "";
        if (items) {
          for (let i = 0; i < items.length; i++) {
            let cid = items[i];
            if (count % 2 === 0)
              extraClass = "shaded";
            else
              extraClass = "";

            let cterm = vowlHelper.getTermById(cid);
            let label = "";

            if (cterm.label["undefined"])
              label = cterm.label["undefined"];
            else if (cterm.label["IRI-based"])
              label = cterm.label["IRI-based"];
            html += "<li class='pointer " + extraClass + "' onclick='showTermDetailsById(" + cid + "," + cterm.id + ")'>"
                    + label + "</li>";
          }
        }
        html += "</ul>";
        return html;
      }

      function showTermDetailsById(id) {
        let term = vowlHelper.getTermById(id);
        return showTermDetails(term);
      }
    </script>

  </body>
</html>